name: Update Retraction Watch DOI index

on:
  # Daily update (01:30 UTC). Adjust as needed.
  schedule:
    - cron: '30 1 * * *'
  # Manual trigger from Actions tab
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download latest retraction_watch.csv
        run: |
          mkdir -p /tmp
          curl -L \
            "https://gitlab.com/crossref/retraction-watch-data/-/raw/main/retraction_watch.csv?ref_type=heads" \
            -o /tmp/retraction_watch.csv

      - name: Build DOI index file
        run: |
          mkdir -p data
          python - << 'PY'
          import csv, re, os, pathlib

          in_path = "/tmp/retraction_watch.csv"
          out_path = "data/retraction_watch_doi_index.txt"

          def normalize_doi(s: str) -> str:
              if not s:
                  return ""
              s = s.strip()
              s = re.sub(r"^https?://(dx\.)?doi\.org/", "", s, flags=re.I)
              s = re.sub(r"^doi:", "", s, flags=re.I)
              return s.lower()

          dois = set()

          with open(in_path, newline="", encoding="utf-8") as f:
              reader = csv.DictReader(f)
              for row in reader:
                  val = (
                      row.get("OriginalPaperDOI")
                      or row.get("originalpaperdoi")
                      or row.get("DOI")
                      or row.get("doi")
                  )
                  if not val:
                      continue
                  norm = normalize_doi(val)
                  if norm:
                      dois.add(norm)

          pathlib.Path(os.path.dirname(out_path)).mkdir(parents=True, exist_ok=True)
          with open(out_path, "w", encoding="utf-8") as f:
              for d in sorted(dois):
                  f.write(d + "\n")

          print(f"Wrote {len(dois)} DOIs to {out_path}")
          PY

      - name: Show generated file (debug)
        run: |
          ls -lh data || echo "no data dir"
          echo "First 5 lines of data/retraction_watch_doi_index.txt:"
          head -n 5 data/retraction_watch_doi_index.txt || echo "FILE MISSING"

      - name: Commit and push if index changed
        run: |
          # Stage the file first so new files are tracked
          git add data/retraction_watch_doi_index.txt

          # If nothing in the index differs from HEAD, bail out
          if git diff --cached --quiet; then
            echo "No changes in retraction_watch_doi_index.txt"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update Retraction Watch DOI index"
          git push
